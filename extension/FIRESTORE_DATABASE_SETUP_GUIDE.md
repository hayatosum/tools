# 🗄️ Firestore Database 作成手順（詳細版）

## 📍 前提条件

-   Firebase プロジェクトが作成済み
-   Firebase Console にログイン済み

---

## 🚀 具体的な手順

### 1. Firebase Console でプロジェクトを開く

1. **Firebase Console にアクセス**
    - https://console.firebase.google.com/ を開く
    - 作成したプロジェクトをクリック

### 2. Firestore Database にアクセス

1. **左サイドバーから「Firestore Database」を選択**
    ```
    🏠 プロジェクトの概要
    👥 Authentication
    🗄️ Firestore Database  ← これをクリック
    ⚡ Functions
    🏗️ Hosting
    ```

### 3. データベースを作成

1. **「データベースの作成」をクリック**
    - 初回の場合、中央に「データベースの作成」ボタンが表示されます
    ```
    ┌─────────────────────────────────┐
    │                                 │
    │      Firestore Database         │
    │                                 │
    │    [データベースの作成]          │
    │                                 │
    └─────────────────────────────────┘
    ```

### 4. セキュリティルールを選択

2 つのオプションが表示されます：

#### 🔒 **本番モード（推奨）**

```
● 本番モードで開始
  セキュアですが、Firebase Authentication、
  Firebase Admin SDK、サーバー側のクライアント
  ライブラリ経由でのみ、読み取りおよび書き込みが可能です。

○ テストモードで開始
```

**✅ 「本番モードで開始」を選択してください**

-   より安全
-   後でカスタムルールを設定予定

#### ⚠️ テストモードについて

```
○ テストモードで開始
  読み取りおよび書き込みアクセスを30日間許可します。
  モバイルおよびウェブクライアントライブラリに適していますが、
  すべてのデータが公開されます。
```

**❌ テストモードは選択しないでください（セキュリティリスク）**

### 5. ロケーションを選択

1. **データベースのロケーションを選択**

    ```
    Cloud Firestore のロケーション
    ┌─────────────────────────────────┐
    │ asia-northeast1 (東京)    ▼    │
    └─────────────────────────────────┘
    ```

2. **推奨ロケーション（日本の場合）**

    - `asia-northeast1 (東京)` - **最推奨**
    - `asia-northeast2 (大阪)`
    - `asia-east1 (台湾)`

3. **重要な注意事項**
    - ⚠️ **ロケーションは後から変更できません**
    - 日本のユーザーが多い場合は東京を選択

### 6. データベース作成の完了

1. **「完了」をクリック**

    ```
    [キャンセル]  [完了]
                  ^^^^^^
                これをクリック
    ```

2. **作成処理の待機**
    - 「データベースを作成しています...」と表示されます
    - 通常 1-2 分で完了

### 7. 作成完了の確認

データベースが作成されると、以下の画面が表示されます：

```
Cloud Firestore
┌─────────────────────────────────────────┐
│ 📊 データ  📝 ルール  📈 使用状況       │
└─────────────────────────────────────────┘

(root)
├── 📁 collections will appear here
```

**✅ この画面が表示されれば作成完了です！**

---

## 🎯 作成後の状態

### ✅ 完了した内容

-   Firestore Database が作成済み
-   本番モードのセキュリティルールが適用済み
-   指定したロケーションにデータベースが配置済み

### 🔒 現在のセキュリティ状態

```javascript
// 現在適用されているルール（デフォルト）
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if false; // 全アクセス拒否
    }
  }
}
```

**⚠️ 重要**: 現在はすべてのアクセスが拒否されています。次のステップでカスタムルールを設定する必要があります。

---

## 🔧 次に必要な設定

### 1. セキュリティルールの設定

現在のままではアプリからアクセスできないため、カスタムルールを設定：

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 設定データ（管理者のみ読み取り可能）
    match /config/allowedUsers {
      allow read: if request.auth != null;
      allow write: if false; // 管理者のみ手動更新
    }

    // ユーザーデータ（本人のみアクセス可能）
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
```

### 2. 許可ユーザーリストの作成

`config/allowedUsers` ドキュメントに許可されたメールアドレスを設定

### 3. Chrome 拡張での動作テスト

すべての設定が完了したら実際に認証をテスト

---

## 🚨 よくあるトラブル

### ❌ 「権限が拒否されました」エラー

**原因**: セキュリティルールが設定されていない  
**解決**: カスタムセキュリティルールを設定

### ❌ 「ネットワークエラー」

**原因**: Firebase SDK の設定ミス  
**解決**: `config.ts`の Firebase 設定を確認

### ❌ データが表示されない

**原因**: ロケーション設定やルールの問題  
**解決**: Firebase Console でデータとルールを確認

---

## ✅ 次のステップ

Firestore Database が作成できたら、次は：

1. **セキュリティルールの設定** 📝
2. **許可ユーザーリストの作成** 👥
3. **Chrome 拡張での動作確認** 🔧

詳細は `FIREBASE_GOOGLE_LOGIN_SETUP.md` の該当セクションを参照してください。
